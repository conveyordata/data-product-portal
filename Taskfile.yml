version: "3"

vars:
  VERSION_FILE: VERSION
  BACKEND_VERSION_FILE: backend/VERSION
  HELM_CHART: helm/Chart.yaml
  HELM_VALUES: helm/values.yaml
  DOCS_CONFIG: docs/docusaurus.config.ts

tasks:
  bump:version-file:
    desc: "Bump version and update all references"
    cmds:
      - |
        echo "New version: {{.CLI_ARGS}}"
        echo "{{.CLI_ARGS}}" > {{.VERSION_FILE}}
        cp {{.VERSION_FILE}} {{.BACKEND_VERSION_FILE}}
        sed -i '' "s/^version:.*/version: {{.CLI_ARGS}}/" {{.HELM_CHART}}
        sed -i '' "s/^  tag:.*/  tag: {{.CLI_ARGS}}/" {{.HELM_VALUES}}

  bump:release-notes:
    desc: "Update release notes with new version and date"
    cmds:
      - |
        node -e '
        const fs = require("fs");
        const file = "docs/docs/release-notes.md";
        const content = fs.readFileSync(file, "utf-8");
        const newVersion = "{{.CLI_ARGS}}";
        const updated = content.replace(/## Unreleased/, `## Unreleased\n\n## ${newVersion}`);
        fs.writeFileSync(file, updated);
        '

  openapi-spec:generate:
    desc: "Update OpenAPI spec with new version"
    generates:
      - docs/static/openapi.json
    dir: backend
    dotenv: [.test.env]
    cmds:
      - poetry run python -m app.open_api_export ../docs/static/openapi.json

  openapi-spec:generate-no-deprecated:
    desc: "Generate OpenAPI spec without deprecated endpoints"
    sources: [docs/static/openapi.json]
    generates: [docs/static/openapi-3.0.json]
    dir: backend
    dotenv: [.test.env]
    cmds:
      - poetry run python -m app.open_api_export ../docs/static/openapi-no-deprecated.json --exclude-deprecated

  go-sdk:setup:
    desc: "Setup Go SDK generation"
    cmds:
      - go install github.com/doordash-oss/oapi-codegen-dd/v3/cmd/oapi-codegen@latest


  go-sdk:generate:
    desc: "Generate the Go SDK from the OpenAPI spec"
    sources: [docs/static/openapi-no-deprecated.json, sdk-go/oapi-codegen.yaml]
    generates: [sdk-go/portalsdk/client.go]
    preconditions:
      - oapi-codegen --help # has no --version flag
    dir: sdk-go
    cmds:
      - mkdir -p portalsdk # inside of sdk-go
      - oapi-codegen --config oapi-codegen.yaml ../docs/static/openapi-no-deprecated.json
      #- sed -i 's/^union json\.RawMessage$/\tunion json.RawMessage/' portalsdk/portalsdk.go
      - gofmt -w portalsdk/
      - cd portalsdk && go mod init github.com/data-product-portal/sdk-go/portalsdk || true
      - cd portalsdk && go mod tidy

  docusaurus:version:
    desc: "Run Docusaurus versioning"
    cmds:
      - cd docs && npm run docusaurus docs:version {{.CLI_ARGS}}

  docusaurus:update-config:
    desc: "Update docusaurus.config.ts with new version"
    cmds:
      - |
        node -e '
        const fs = require("fs");
        const file = "{{.DOCS_CONFIG}}";
        const config = fs.readFileSync(file, "utf-8");
        const currentVersion = config.match(/Latest \((.*?)\)/)?.[1];
        const newVersion = "{{.CLI_ARGS}}";
        const updated = config
          .replace(/Latest \((.*?)\)/, `Latest (${newVersion})`)
          .replace(/versions:\s*{/, match => {
            const newEntry = `\t\t\t\t\t\t\t"${newVersion}": {\n\t\t\t\t\t\t\t\tlabel: "${newVersion}",\n\t\t\t\t\t\t\tpath: "${newVersion}"\n\t\t\t\t\t\t\t},`;
            return `${match}\n${newEntry}`;
          });
        fs.writeFileSync(file, updated);
        '

  docusaurus:build:
    desc: "Build Docusaurus"
    cmds:
      - cd docs && npm run build

  release:commit:
    desc: "Commit and push the version bump"
    cmds:
      - git add .
      - 'git commit -m "chore: release {{.CLI_ARGS}}"'
      - git push origin HEAD

  release:pr:
    desc: "Open PR (requires gh CLI)"
    cmds:
      - gh pr create --fill --title "Release {{.CLI_ARGS}}" --body "Automated release for {{.CLI_ARGS}}"

  release:post:
    desc: "Tag and deploy docs after merge"
    cmds:
      - git tag {{.CLI_ARGS}}
      - git push --tags
      - aws s3 sync docs/build/ s3://{{.S3_DOCS_BUCKET}} --delete

  bump-docs:
    desc: "Bump docs version, execute on minor releases e.g. bump-docs 0.2.x"
    cmds:
      - task: docusaurus:version
      - task: docusaurus:update-config
      - task: docusaurus:build
      - task: release:commit
      - task: release:pr

  bump-version:
    desc: "Generic version bump without docs, execute on all releases, e.g. bump-version 0.2.0"
    cmds:
      - task: bump:version-file
      - task: bump:release-notes
      - task: update:openapi-spec
      - task: release:commit
      - task: release:pr

  poetry:setup:
    desc: "Install the backend python project so the precommit does not fail"
    dir: backend
    cmds:
      - poetry install
