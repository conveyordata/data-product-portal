name: Alembic latest migration test
on:
  push:
    branches: [ "main", "feature/test-latest-migration" ]
  pull_request:
    paths:
      - 'backend/app/database/alembic/**'
permissions:
  contents: read
jobs:
  incremental_migration_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - name: Pull Docker Images
        run: docker compose pull

      - name: Start DB container only
        run: docker compose up -d postgresql backend

      - name: Wait for Postgres
        run: |
          for i in {1..10}; do
            if pg_isready -h localhost -p 5432; then
              break
            fi
            sleep 3
          done
      - name: Wait for Backend
        run: |
            for i in {1..10}; do
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" localhost:5050)
              echo "Status code: $STATUS_CODE"
              test $STATUS_CODE -eq 200
              if test $STATUS_CODE -eq 200; then
                break
              fi
              sleep 3
            done

      - name: Downgrade to previous migration
        run: |
          docker compose exec backend alembic downgrade -1

      - name: Upgrade only latest migration
        run: |
          docker compose exec backend alembic upgrade head

      - name: Start remaining services
        run: docker compose up -d frontend nginx

      - name: Curl Test API Frontend
        run: |
            for i in {1..10}; do
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" localhost:8080)
              echo "Status code: $STATUS_CODE"
              test $STATUS_CODE -eq 200
              if test $STATUS_CODE -eq 200; then
                break
              fi
              sleep 3
            done
